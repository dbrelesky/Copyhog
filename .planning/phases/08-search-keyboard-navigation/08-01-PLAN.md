---
phase: 08-search-keyboard-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Copyhog/Copyhog/Store/ClipItemStore.swift
  - Copyhog/Copyhog/Views/PopoverContent.swift
  - Copyhog/Copyhog/Views/ItemRow.swift
autonomous: true
requirements:
  - SRCH-01
  - SRCH-02
  - SRCH-03

must_haves:
  truths:
    - "User can type in a search field at the top of the popover and items filter in real-time"
    - "Clearing the search field restores the full history list with pinned items at the top"
    - "Matched text is visually highlighted in search results"
    - "Search filters both pinned and unpinned items equally"
    - "No-results state shows a helpful message when nothing matches"
  artifacts:
    - path: "Copyhog/Copyhog/Store/ClipItemStore.swift"
      provides: "searchQuery property and displayItems computed property"
      contains: "displayItems"
    - path: "Copyhog/Copyhog/Views/PopoverContent.swift"
      provides: "Search TextField with debounced filtering"
      contains: "Search history..."
    - path: "Copyhog/Copyhog/Views/ItemRow.swift"
      provides: "Search highlight support and keyboard selection highlight"
      contains: "isSelected"
  key_links:
    - from: "Copyhog/Copyhog/Views/PopoverContent.swift"
      to: "Copyhog/Copyhog/Store/ClipItemStore.swift"
      via: "searchText onChange debounce pushes to store.searchQuery"
      pattern: "store\\.searchQuery"
    - from: "Copyhog/Copyhog/Store/ClipItemStore.swift"
      to: "Copyhog/Copyhog/Views/PopoverContent.swift"
      via: "displayItems computed property drives ForEach rendering"
      pattern: "store\\.displayItems"
---

<objective>
Add real-time search filtering to the clipboard history popover. A search TextField at the top filters items by text content and source app name as the user types (debounced at 150ms). Matched text is highlighted in results. When search is cleared, the full sectioned Pinned/History layout is restored.

Purpose: Users can instantly find any item in a history of up to 500 items without scrolling.
Output: Working search field with real-time filtering, text highlighting, and no-results empty state.
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-search-keyboard-navigation/08-RESEARCH.md
@Copyhog/Copyhog/Store/ClipItemStore.swift
@Copyhog/Copyhog/Views/PopoverContent.swift
@Copyhog/Copyhog/Views/ItemRow.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search query and displayItems to ClipItemStore + search TextField and debounce in PopoverContent</name>
  <files>
    Copyhog/Copyhog/Store/ClipItemStore.swift
    Copyhog/Copyhog/Views/PopoverContent.swift
  </files>
  <action>
**ClipItemStore.swift:**
1. Add `@Published var searchQuery: String = ""` property
2. Add a `var displayItems: [ClipItem]` computed property:
   - When `searchQuery.isEmpty`, return `items` as-is (already sorted pinned-first by `sortItems()`)
   - When `searchQuery` is not empty, filter `items`:
     - Exclude items where `isSensitive == true` (hidden items should not appear in search results)
     - Match if `item.content?.localizedCaseInsensitiveContains(searchQuery) == true`
     - OR if `item.sourceAppName?.localizedCaseInsensitiveContains(searchQuery) == true`
     - Images without text content AND no matching source app name return false
   - Return the filtered array (maintains pinned-first sort order from the source)

**PopoverContent.swift:**
1. Add `@State private var searchText: String = ""` and `@State private var searchTask: Task<Void, Never>?` state variables
2. Add a search bar between the PreviewPane and the toolbar, inside the main VStack. Use an HStack with:
   - `Image(systemName: "magnifyingglass")` left icon, `.foregroundStyle(.secondary)`, `.font(.system(size: 12))`
   - `TextField("Search history...", text: $searchText)` with `.textFieldStyle(.plain)`, `.font(.system(size: 13))`, `.onSubmit { }` (prevent Enter from doing anything in search field)
   - Conditional clear button (only when `!searchText.isEmpty`): `Button` with `Image(systemName: "xmark.circle.fill")`, `.foregroundStyle(.secondary)`, `.buttonStyle(.borderless)` — on tap, set `searchText = ""` and `store.searchQuery = ""`
   - Wrap the HStack with `.padding(.horizontal, 10)`, `.padding(.vertical, 6)`, `.background(Color(red: 0.4, green: 0.2, blue: 0.5).opacity(0.1))`, `.clipShape(RoundedRectangle(cornerRadius: 8))`, `.padding(.horizontal, 8)`, `.padding(.top, 4)`
3. Add `.onChange(of: searchText)` modifier that debounces at 150ms before pushing to `store.searchQuery`:
   ```swift
   .onChange(of: searchText) { _, newValue in
       searchTask?.cancel()
       searchTask = Task {
           try? await Task.sleep(nanoseconds: 150_000_000)
           guard !Task.isCancelled else { return }
           store.searchQuery = newValue
       }
   }
   ```
4. Update the item list section to use `store.displayItems` instead of `store.items`:
   - Replace `let pinnedItems = store.items.filter { $0.isPinned }` with `let pinnedItems = store.displayItems.filter { $0.isPinned }`
   - Replace `let unpinnedItems = store.items.filter { !$0.isPinned }` with `let unpinnedItems = store.displayItems.filter { !$0.isPinned }`
   - When search is active (`!store.searchQuery.isEmpty`), show results as a single flat grid WITHOUT section headers. When search is empty, show the existing Pinned/History sectioned layout. This prevents empty "Pinned" headers during search.
5. Add a no-results empty state: when `store.displayItems.isEmpty && !store.searchQuery.isEmpty`, show a centered VStack with magnifying glass icon, "No results for [query]" text, and "Try a different search term" caption. Use `.foregroundStyle(.tertiary)` and `.foregroundStyle(.secondary)`.
6. Update the `previewItem` computed property to use `store.displayItems` instead of `store.items` for the fallback:
   ```swift
   private var previewItem: ClipItem? {
       if let hoveredID = hoveredItemID {
           return store.displayItems.first { $0.id == hoveredID }
       }
       return store.displayItems.first
   }
   ```
7. In `.onDisappear`, reset search state: `searchText = ""`, `store.searchQuery = ""`, `searchTask?.cancel()`
8. Update the empty state check: use `store.items.isEmpty` (not `displayItems`) for the "No Clips Yet" empty state — this is the global empty state, not the search empty state.
  </action>
  <verify>Build the project with `cd Copyhog && xcodebuild -scheme Copyhog -destination 'platform=macOS' build 2>&1 | tail -20`. Verify no compiler errors. Verify that `ClipItemStore` has `searchQuery` and `displayItems` properties.</verify>
  <done>Search TextField appears between preview pane and toolbar. Typing filters items in real-time with 150ms debounce. Clearing search restores full sectioned layout. Hidden items excluded from search. No-results shows empty state message.</done>
</task>

<task type="auto">
  <name>Task 2: Add search text highlighting and keyboard selection visual to ItemRow</name>
  <files>
    Copyhog/Copyhog/Views/ItemRow.swift
    Copyhog/Copyhog/Views/PopoverContent.swift
  </files>
  <action>
**ItemRow.swift:**
1. Add two new parameters to ItemRow:
   - `let isSelected: Bool` (default `false`) — for keyboard selection highlight (Plan 02 will use this)
   - `var searchQuery: String = ""` — for text highlighting in search results
2. Add a private helper function `highlightedText(content:query:) -> AttributedString`:
   - Create an `AttributedString` from the content
   - If query is empty, return as-is
   - Find all occurrences of query (case-insensitive) in content using `lowercased()` comparison
   - For each match range, set `.foregroundColor = Color(red: 0.7, green: 0.4, blue: 0.85)` and `.font = .system(size: 10, weight: .bold)`
   - Return the attributed string
   - Use the approach from the research: convert String.Index ranges to AttributedString.Index via `AttributedString.Index(_:within:)`
3. Update `textCardContent`: when `searchQuery` is not empty and item is not sensitive, use `Text(highlightedText(content: item.content ?? "", query: searchQuery))` instead of `Text(item.content ?? "")`. Keep the same `.font(.system(size: 10))` and other modifiers.
4. Update the `.overlay` on the card to include keyboard selection state. When `isSelected` is true, show a prominent border:
   - `isSelected ? Color(red: 0.7, green: 0.4, blue: 0.85).opacity(0.8) : ...existing logic...`
   - `lineWidth: isSelected ? 2 : (item.isSensitive ? 1.5 : 1)`
5. Add a subtle selection shadow when `isSelected`: increase shadow opacity to 0.3 regardless of hover.

**PopoverContent.swift:**
1. Update all ItemRow instantiations to pass the new parameters:
   - `isSelected: false` (will be wired in Plan 02)
   - `searchQuery: store.searchQuery`
  </action>
  <verify>Build the project with `cd Copyhog && xcodebuild -scheme Copyhog -destination 'platform=macOS' build 2>&1 | tail -20`. Verify no compiler errors. Verify ItemRow accepts `isSelected` and `searchQuery` parameters.</verify>
  <done>Text items show highlighted matches (purple bold) when search query matches. ItemRow supports `isSelected` parameter for keyboard selection visual (ready for Plan 02). All ItemRow call sites pass the new parameters.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd Copyhog && xcodebuild -scheme Copyhog -destination 'platform=macOS' build`
2. ClipItemStore has `searchQuery` (@Published) and `displayItems` (computed) properties
3. PopoverContent shows search bar with magnifying glass icon and placeholder "Search history..."
4. Search field filters items in real-time; clearing restores full list
5. When search is active, results are a flat grid (no section headers); when cleared, Pinned/History sections return
6. Text items highlight matched text in purple bold
7. No-results state shows helpful empty state message
8. ItemRow accepts `isSelected` and `searchQuery` parameters
</verification>

<success_criteria>
- SRCH-01: Search field at top of popover filters history items by text content and source app name
- SRCH-02: Results update in real-time with 150ms debounce
- SRCH-03: Clearing search field restores full history list with pinned items at top
- ItemRow is prepared for keyboard selection highlight (isSelected parameter ready for Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/08-search-keyboard-navigation/08-01-SUMMARY.md`
</output>
