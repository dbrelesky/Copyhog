---
phase: 06-screenshot-auto-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Copyhog/Copyhog/Copyhog.entitlements
  - Copyhog/Copyhog/Services/ScreenshotLocationDetector.swift
  - Copyhog/Copyhog/Views/OnboardingView.swift
autonomous: true
requirements:
  - SCRN-04
  - SCRN-05
  - SCRN-06

must_haves:
  truths:
    - "On first launch, the app detects the macOS screenshot save location and shows it in onboarding without the user having to browse for it"
    - "If the user has a custom screenshot location (e.g. ~/Pictures/Screenshots), that location is detected and displayed — not ~/Desktop"
    - "If no custom screenshot location is configured, ~/Desktop is shown as the default"
    - "User can accept the detected location with one click or change it via folder picker"
  artifacts:
    - path: "Copyhog/Copyhog/Services/ScreenshotLocationDetector.swift"
      provides: "Screenshot location detection from com.apple.screencapture defaults"
      contains: "ScreenshotLocationDetector"
    - path: "Copyhog/Copyhog/Copyhog.entitlements"
      provides: "Sandbox entitlement for reading screencapture preferences"
      contains: "com.apple.security.temporary-exception.shared-preference.read-only"
    - path: "Copyhog/Copyhog/Views/OnboardingView.swift"
      provides: "Pre-fill + confirm/change onboarding flow for screenshot folder"
      contains: "ScreenshotLocationDetector"
  key_links:
    - from: "Copyhog/Copyhog/Services/ScreenshotLocationDetector.swift"
      to: "com.apple.screencapture UserDefaults domain"
      via: "UserDefaults(suiteName:) read with shared-preference entitlement"
      pattern: 'UserDefaults\(suiteName: "com\.apple\.screencapture"\)'
    - from: "Copyhog/Copyhog/Views/OnboardingView.swift"
      to: "Copyhog/Copyhog/Services/ScreenshotLocationDetector.swift"
      via: "Calls detect() to pre-fill onboarding folder row"
      pattern: "ScreenshotLocationDetector\\.detect\\(\\)"
---

<objective>
Add screenshot location auto-detection so the onboarding flow pre-fills the user's macOS screenshot save location instead of requiring manual folder selection from scratch.

Purpose: Users with custom screenshot locations (set via Cmd+Shift+5 > Options > Save to) see their actual folder detected automatically. Users with default settings see ~/Desktop. Either way, one click confirms — no hunting through Finder.

Output: ScreenshotLocationDetector utility, updated entitlements, and modified OnboardingView with confirm/change UX.
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-screenshot-auto-detection/6-RESEARCH.md

@Copyhog/Copyhog/Services/BookmarkManager.swift
@Copyhog/Copyhog/Views/OnboardingView.swift
@Copyhog/Copyhog/Copyhog.entitlements
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ScreenshotLocationDetector utility and sandbox entitlement</name>
  <files>
    Copyhog/Copyhog/Services/ScreenshotLocationDetector.swift
    Copyhog/Copyhog/Copyhog.entitlements
  </files>
  <action>
    1. Create `Copyhog/Copyhog/Services/ScreenshotLocationDetector.swift` with a `struct ScreenshotLocationDetector`:
       - Static method `detect() -> URL` that:
         a. Reads `UserDefaults(suiteName: "com.apple.screencapture")?.string(forKey: "location")`
         b. If non-nil and non-empty, expand tilde with `(location as NSString).expandingTildeInPath`
         c. Construct URL with `URL(fileURLWithPath: expanded)`
         d. Validate with `FileManager.default.fileExists(atPath: url.path)` — if valid, return it
         e. If nil, empty, or path doesn't exist, fall back to `FileManager.default.homeDirectoryForCurrentUser.appendingPathComponent("Desktop")`
       - This is a pure utility with no state.

    2. Modify `Copyhog/Copyhog/Copyhog.entitlements` to add the shared-preference read-only temporary exception:
       - Add key `com.apple.security.temporary-exception.shared-preference.read-only` with an array value containing the string `com.apple.screencapture`
       - This allows the sandboxed app to read the screencapture preference domain via UserDefaults(suiteName:)
       - Place it after the existing `com.apple.security.files.bookmarks.app-scope` entry

    3. Add the new Swift file to the Xcode project. Use the PBX pattern from existing files in the Services group — find the Services group reference and add ScreenshotLocationDetector.swift alongside ScreenshotWatcher.swift and BookmarkManager.swift. Use `ruby` or `sed` on the pbxproj file to add the file reference and build source entry, following the exact pattern used by existing Service files.
  </action>
  <verify>
    - `ScreenshotLocationDetector.swift` exists at `Copyhog/Copyhog/Services/ScreenshotLocationDetector.swift`
    - The entitlements plist is valid XML: `plutil -lint Copyhog/Copyhog/Copyhog.entitlements`
    - The entitlements contain the shared-preference key: `grep "shared-preference" Copyhog/Copyhog/Copyhog.entitlements`
    - Project builds: `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -configuration Debug build 2>&1 | tail -5`
  </verify>
  <done>
    ScreenshotLocationDetector.detect() returns a valid URL (custom location if set, ~/Desktop otherwise). The sandbox entitlement permits reading com.apple.screencapture preferences. The project compiles with the new file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OnboardingView with pre-fill + confirm/change UX</name>
  <files>
    Copyhog/Copyhog/Views/OnboardingView.swift
  </files>
  <action>
    Modify `OnboardingView.swift` to replace the manual "Select..." flow for the screenshot folder (step 1) with a detect-and-confirm flow:

    1. Add a `@State private var detectedScreenshotURL: URL = ScreenshotLocationDetector.detect()` property.

    2. Replace the step 1 `folderRow` call with a custom row that shows:
       - The detected path as secondary text under "Screenshot Folder" (use `detectedScreenshotURL.path`)
       - Two buttons instead of the single "Select..." button:
         a. "Use This" — calls `bookmarkManager.saveBookmark(url: detectedScreenshotURL, key: BookmarkManager.screenshotSourceKey)` and sets `screenshotGranted = true`
         b. "Change..." — calls the existing `selectScreenshotFolder()` method (which opens NSOpenPanel)
       - Keep the same visual styling as the existing `folderRow` (rounded rectangle background, step number/checkmark, material background)
       - When `screenshotGranted` is true, show the checkmark icon (same as current behavior) and hide both buttons

    3. Update `selectScreenshotFolder()` to pre-set `panel.directoryURL = detectedScreenshotURL` instead of the inline detection code currently at lines 131-137. Remove the duplicate detection logic from that method since ScreenshotLocationDetector now handles it.

    4. Keep step 2 (Screenies folder) and the bottom buttons exactly as they are — no changes to those.

    Important: The description text under step 1 should show the actual detected path (e.g., "~/Desktop" or "~/Pictures/Screenshots") so the user knows what they're confirming. Use a shortened display path — replace the home directory prefix with `~` for display.
  </action>
  <verify>
    - Project builds: `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -configuration Debug build 2>&1 | tail -5`
    - OnboardingView references ScreenshotLocationDetector: `grep "ScreenshotLocationDetector" Copyhog/Copyhog/Views/OnboardingView.swift`
    - "Use This" button exists: `grep "Use This" Copyhog/Copyhog/Views/OnboardingView.swift`
    - "Change..." button exists: `grep "Change" Copyhog/Copyhog/Views/OnboardingView.swift`
    - Old inline detection code removed: no `UserDefaults(suiteName: "com.apple.screencapture")` in OnboardingView
  </verify>
  <done>
    The onboarding screenshot folder row shows the auto-detected path with "Use This" and "Change..." buttons. Users can confirm with one click or override via NSOpenPanel. The duplicate detection logic is removed from OnboardingView in favor of ScreenshotLocationDetector.
  </done>
</task>

</tasks>

<verification>
1. `plutil -lint Copyhog/Copyhog/Copyhog.entitlements` passes
2. `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -configuration Debug build` succeeds
3. `ScreenshotLocationDetector.swift` exists with `detect()` method
4. `OnboardingView.swift` uses `ScreenshotLocationDetector.detect()` and shows "Use This" / "Change..." buttons
5. No `UserDefaults(suiteName: "com.apple.screencapture")` references remain in OnboardingView (moved to detector)
6. Entitlements file contains `com.apple.security.temporary-exception.shared-preference.read-only` with `com.apple.screencapture`
</verification>

<success_criteria>
- The app auto-detects the macOS screenshot save location on first launch (SCRN-04)
- The onboarding pre-fills the detected folder with confirm/change buttons (SCRN-05)
- When no custom location is set, ~/Desktop is shown as the default (SCRN-06)
- The sandbox entitlement enables cross-domain UserDefaults reads for screencapture preferences
- The project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-screenshot-auto-detection/06-01-SUMMARY.md`
</output>
