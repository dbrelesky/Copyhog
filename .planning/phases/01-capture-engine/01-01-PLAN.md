---
phase: 01-capture-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Copyhog/Copyhog.xcodeproj/project.pbxproj
  - Copyhog/Copyhog/CopyhogApp.swift
  - Copyhog/Copyhog/Info.plist
  - Copyhog/Copyhog/Copyhog.entitlements
  - Copyhog/Copyhog/Assets.xcassets/MenuBarIcon.imageset/Contents.json
  - Copyhog/Copyhog/Assets.xcassets/MenuBarIcon.imageset/hedgehog-16.png
  - Copyhog/Copyhog/Assets.xcassets/MenuBarIcon.imageset/hedgehog-32.png
  - Copyhog/Copyhog/Views/PopoverContent.swift
autonomous: false

must_haves:
  truths:
    - "A hedgehog icon appears in the macOS menu bar"
    - "Clicking the menu bar icon opens a popover window approximately 360x480px"
    - "Pressing Shift+Up Arrow toggles the popover open and closed from any app"
    - "The app launches at login and runs silently in background (no dock icon)"
  artifacts:
    - path: "Copyhog/Copyhog/CopyhogApp.swift"
      provides: "MenuBarExtra scene with window style, global hotkey registration, launch-at-login"
      contains: "MenuBarExtra"
    - path: "Copyhog/Copyhog/Info.plist"
      provides: "LSUIElement = YES to hide dock icon"
      contains: "LSUIElement"
    - path: "Copyhog/Copyhog/Copyhog.entitlements"
      provides: "App Sandbox disabled for global hotkey"
    - path: "Copyhog/Copyhog/Views/PopoverContent.swift"
      provides: "Empty popover placeholder view at 360x480"
    - path: "Copyhog/Copyhog.xcodeproj/project.pbxproj"
      provides: "Xcode project with correct build settings"
  key_links:
    - from: "CopyhogApp.swift"
      to: "PopoverContent.swift"
      via: "MenuBarExtra content closure"
      pattern: "PopoverContent"
    - from: "CopyhogApp.swift"
      to: "NSEvent.addGlobalMonitorForEvents"
      via: "Global hotkey registration in init or onAppear"
      pattern: "addGlobalMonitorForEvents"
---

<objective>
Create the Copyhog Xcode project and menu bar app shell with an empty popover, global hotkey, and launch-at-login.

Purpose: Establishes the foundational app structure that all subsequent plans build upon — the Xcode project, menu bar presence, popover window, and background execution.
Output: A buildable macOS menu bar app with hedgehog icon, 360x480 popover, Shift+Up Arrow hotkey, and launch-at-login registration.
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-capture-engine/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Xcode project and configure app shell</name>
  <files>
    Copyhog/Copyhog.xcodeproj/project.pbxproj
    Copyhog/Copyhog/CopyhogApp.swift
    Copyhog/Copyhog/Info.plist
    Copyhog/Copyhog/Copyhog.entitlements
    Copyhog/Copyhog/Assets.xcassets/MenuBarIcon.imageset/Contents.json
    Copyhog/Copyhog/Assets.xcassets/MenuBarIcon.imageset/hedgehog-16.png
    Copyhog/Copyhog/Assets.xcassets/MenuBarIcon.imageset/hedgehog-32.png
  </files>
  <action>
    Create the Xcode project for a macOS app using `xcodebuild` or by generating the project structure manually:

    1. **Project scaffold:** Create the directory structure:
       ```
       Copyhog/
       ├── Copyhog.xcodeproj/
       ├── Copyhog/
       │   ├── CopyhogApp.swift
       │   ├── Info.plist
       │   ├── Copyhog.entitlements
       │   └── Assets.xcassets/
       │       ├── Contents.json
       │       ├── AppIcon.appiconset/Contents.json
       │       └── MenuBarIcon.imageset/
       ```

    2. **Info.plist:** Set `LSUIElement` to `YES` (hides dock icon, menu bar only). Set bundle identifier to `com.copyhog.app`. Set minimum deployment target to macOS 14.0.

    3. **Entitlements:** Set `com.apple.security.app-sandbox` to `NO` (required for `NSEvent.addGlobalMonitorForEvents` to work for global hotkey).

    4. **Menu bar icon:** Create a simple hedgehog silhouette template image for the menu bar. Generate 16x16 (@1x) and 32x32 (@2x) PNG files. These should be simple black silhouettes — macOS will auto-adapt for light/dark mode when `isTemplate = true`. If programmatic generation is impractical, use SF Symbol `circle.fill` as a placeholder and document that the hedgehog icon needs to be added manually.

    5. **Asset catalog:** Configure `MenuBarIcon.imageset/Contents.json` to reference both @1x and @2x images with `"template-rendering-intent": "template"`.

    6. **Xcode project file (.pbxproj):** This is the critical piece. Options:
       - **Preferred:** Use `swift package init --type executable` as base, then create the .xcodeproj via `xcodebuild -create-xcproject` or generate with a script. The project must target macOS 14.0+, use Swift 6.2, and include the Info.plist and entitlements.
       - **Alternative:** If programmatic xcodeproj generation is unreliable, create a Package.swift that builds an executable, and document that the user needs to open Xcode once to create the project. However, attempt the xcodeproj approach first.
       - **Fallback:** Use `xcodegen` or write the pbxproj manually (it's a structured plist format). Many open-source tools exist for this.

    Build settings must include:
    - `MACOSX_DEPLOYMENT_TARGET = 14.0`
    - `SWIFT_VERSION = 6.0` (Xcode's Swift language version setting)
    - `INFOPLIST_FILE = Copyhog/Info.plist`
    - `CODE_SIGN_ENTITLEMENTS = Copyhog/Copyhog.entitlements`
    - `PRODUCT_BUNDLE_IDENTIFIER = com.copyhog.app`

    Verify the project builds: `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog build`
  </action>
  <verify>
    Run `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog build 2>&1 | tail -5` — should show "BUILD SUCCEEDED".
    Verify Info.plist contains LSUIElement: `grep -c LSUIElement Copyhog/Copyhog/Info.plist` returns 1.
    Verify entitlements disable sandbox: `grep -c "app-sandbox" Copyhog/Copyhog/Copyhog.entitlements` returns 1.
  </verify>
  <done>
    Xcode project builds successfully. Info.plist has LSUIElement = YES. Entitlements have App Sandbox = NO. Asset catalog has MenuBarIcon imageset configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement MenuBarExtra popover, global hotkey, and launch-at-login</name>
  <files>
    Copyhog/Copyhog/CopyhogApp.swift
    Copyhog/Copyhog/Views/PopoverContent.swift
  </files>
  <action>
    1. **PopoverContent.swift:** Create a placeholder SwiftUI view for the popover:
       ```swift
       import SwiftUI

       struct PopoverContent: View {
           var body: some View {
               VStack {
                   Spacer()
                   Text("Copyhog")
                       .font(.title2)
                       .foregroundStyle(.secondary)
                   Text("No items yet")
                       .font(.caption)
                       .foregroundStyle(.tertiary)
                   Spacer()
               }
               .frame(width: 360, height: 480)
           }
       }
       ```
       The `.frame(width: 360, height: 480)` is critical — `MenuBarExtra` with `.window` style sizes based on content intrinsic size. Without explicit frame, the popover collapses.

    2. **CopyhogApp.swift:** Implement the `@main` App struct with:

       a. **MenuBarExtra scene** using `.menuBarExtraStyle(.window)`:
          - Content: `PopoverContent()` with `.frame(width: 360, height: 480)`
          - Label: Load `NSImage(named: "MenuBarIcon")`, resize to 18pt height (maintaining aspect ratio), set `isTemplate = true`, wrap in `Image(nsImage:)`. If the custom icon isn't available, fall back to `Image(systemName: "circle.fill")`.

       b. **Global hotkey (Shift+Up Arrow):** Register in an `init()` or `.onAppear` block:
          - Use `NSEvent.addGlobalMonitorForEvents(matching: .keyDown)` for events when other apps are frontmost
          - Use `NSEvent.addLocalMonitorForEvents(matching: .keyDown)` for events when Copyhog is frontmost
          - Check: `event.modifierFlags.contains(.shift) && event.keyCode == 126` (126 = Up Arrow)
          - On match: Toggle the popover. Note: `MenuBarExtra` with `.window` style doesn't expose a direct toggle API. Workaround options:
            - Use `NSApp.activate(ignoringOtherApps: true)` to bring the popover forward, or
            - Use `NSStatusItem` approach instead of pure `MenuBarExtra` if toggle is needed, or
            - Store a reference to the panel/window and call `orderFront`/`orderOut`
          - **Important:** The global monitor receives copies of events — Shift+Up will also trigger text selection in the foreground app. This is acceptable per the requirements and research.

       c. **Launch at login:** Call `try? SMAppService.mainApp.register()` in `init()`. Import `ServiceManagement`.

       d. **Accessibility permission prompt:** Call `AXIsProcessTrustedWithOptions` with the prompt option on first launch to request Accessibility permission for the global hotkey to work.

    Verify the app builds and runs: `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog build`
  </action>
  <verify>
    Run `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog build 2>&1 | tail -5` — should show "BUILD SUCCEEDED".
    Verify CopyhogApp.swift contains MenuBarExtra: `grep -c "MenuBarExtra" Copyhog/Copyhog/CopyhogApp.swift` returns at least 1.
    Verify global hotkey registration: `grep -c "addGlobalMonitorForEvents" Copyhog/Copyhog/CopyhogApp.swift` returns at least 1.
    Verify launch-at-login: `grep -c "SMAppService" Copyhog/Copyhog/CopyhogApp.swift` returns at least 1.
  </verify>
  <done>
    App builds successfully. MenuBarExtra with .window style renders PopoverContent at 360x480. Global hotkey (Shift+Up Arrow) is registered via NSEvent monitors. Launch-at-login is registered via SMAppService. Accessibility permission is prompted on first launch.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify menu bar app shell works</name>
  <action>
    Human verification checkpoint. What was built: Menu bar app with hedgehog icon, popover window, global hotkey, and launch-at-login.

    Steps to verify:
    1. Build and run: `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog build` then open the built app from DerivedData, OR open the project in Xcode and press Cmd+R
    2. Verify a hedgehog icon (or circle placeholder) appears in the macOS menu bar
    3. Click the icon — a popover window (~360x480px) should appear with "Copyhog" and "No items yet" text
    4. Click away or click the icon again — popover should dismiss
    5. From any other app, press Shift+Up Arrow — the popover should toggle (grant Accessibility permission if prompted)
    6. Check System Settings > General > Login Items — Copyhog should appear as a login item
    7. Verify no Dock icon appears for the app
  </action>
  <verify>User confirms all 7 verification steps pass</verify>
  <done>User types "approved" — menu bar shell verified working</done>
</task>

</tasks>

<verification>
Phase 1 Plan 01 checks:
- [ ] Xcode project builds without errors
- [ ] Menu bar icon visible
- [ ] Popover opens on click (~360x480px)
- [ ] Shift+Up Arrow toggles popover from any app
- [ ] No dock icon (LSUIElement = YES)
- [ ] Launch-at-login registered
</verification>

<success_criteria>
1. `xcodebuild build` succeeds with zero errors
2. App runs as menu bar utility with visible icon
3. Clicking icon opens 360x480 popover
4. Shift+Up Arrow hotkey works globally
5. App registered for launch at login
</success_criteria>

<output>
After completion, create `.planning/phases/01-capture-engine/01-01-SUMMARY.md`
</output>
