---
phase: 04.1-settings-menu-with-hotkey-config-version-display-attribution-and-relocated-actions
plan: 02
type: execute
wave: 2
depends_on:
  - 04.1-01
files_modified:
  - Copyhog/Copyhog/Models/HotkeyConfig.swift
  - Copyhog/Copyhog/CopyhogApp.swift
  - Copyhog/Copyhog/Views/SettingsMenu.swift
autonomous: true
requirements:
  - SETTINGS-05

must_haves:
  truths:
    - "User can change the global hotkey from the settings menu"
    - "Changed hotkey persists across app restarts"
    - "The new hotkey works to toggle the popover"
    - "Settings menu displays the current hotkey binding"
  artifacts:
    - path: "Copyhog/Copyhog/Models/HotkeyConfig.swift"
      provides: "UserDefaults-backed hotkey configuration model"
    - path: "Copyhog/Copyhog/CopyhogApp.swift"
      provides: "Dynamic hotkey registration from HotkeyConfig"
    - path: "Copyhog/Copyhog/Views/SettingsMenu.swift"
      provides: "Hotkey configuration UI in settings menu"
  key_links:
    - from: "Copyhog/Copyhog/CopyhogApp.swift"
      to: "Copyhog/Copyhog/Models/HotkeyConfig.swift"
      via: "Reads hotkey config for event matching"
      pattern: "HotkeyConfig"
    - from: "Copyhog/Copyhog/Views/SettingsMenu.swift"
      to: "Copyhog/Copyhog/Models/HotkeyConfig.swift"
      via: "Reads/writes hotkey config from UI"
      pattern: "HotkeyConfig"
---

<objective>
Add hotkey configuration support so users can change the global toggle hotkey from the settings menu. The hotkey choice persists via UserDefaults and the AppDelegate dynamically reads it when matching key events.

Purpose: Let users customize the global hotkey instead of being locked to Shift+Ctrl+C.
Output: HotkeyConfig.swift (new model), updated CopyhogApp.swift, updated SettingsMenu.swift
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@Copyhog/Copyhog/CopyhogApp.swift
@Copyhog/Copyhog/Views/SettingsMenu.swift
@.planning/phases/04.1-settings-menu-with-hotkey-config-version-display-attribution-and-relocated-actions/04.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HotkeyConfig model and update AppDelegate to use it</name>
  <files>
    Copyhog/Copyhog/Models/HotkeyConfig.swift
    Copyhog/Copyhog/CopyhogApp.swift
  </files>
  <action>
**Create HotkeyConfig.swift** in the Models directory:

A simple struct/class that reads and writes hotkey configuration to UserDefaults.

Properties:
- `keyCode: UInt16` — The virtual key code (default: 8, which is 'C')
- `modifierFlags: NSEvent.ModifierFlags` — The modifier combination (default: [.shift, .control])

Storage approach:
- Use UserDefaults with keys `"hotkeyKeyCode"` (Int) and `"hotkeyModifiers"` (UInt — raw value of NSEvent.ModifierFlags)
- Provide a static `shared` instance
- Provide `save()` and `load()` methods (or compute from UserDefaults on access)
- Provide a computed `displayString` property that returns a human-readable string like "Shift+Ctrl+C" by mapping modifier flags and key code to characters

Provide a set of preset hotkey options as static properties or an enum:
- Shift+Ctrl+C (default, keyCode 8)
- Shift+Ctrl+V (keyCode 9)
- Shift+Ctrl+H (keyCode 4)
- Cmd+Shift+V (keyCode 9, modifiers [.command, .shift])

Use a simple preset-selection approach rather than a key recorder (key recorders require complex NSEvent handling and are out of scope). Each preset is a `(label: String, keyCode: UInt16, modifiers: NSEvent.ModifierFlags)` tuple or similar.

**Update CopyhogApp.swift** — Modify AppDelegate:

1. In `isHotkeyEvent(_:)`, replace the hardcoded keyCode 8 and [.shift, .control] check with values read from `HotkeyConfig.shared`. Load the config's keyCode and modifiers. Check `event.keyCode == config.keyCode` and `flags.contains(config.modifierFlags)`. Also verify no extra modifiers are pressed (exclude modifiers NOT in the config).

2. Add a method `reregisterHotkey()` on AppDelegate that removes existing monitors and re-registers them. This will be called when the hotkey config changes. Expose this via a notification or make AppDelegate observable. Simplest approach: post a `Notification.Name("HotkeyConfigChanged")` from HotkeyConfig.save(), and have AppDelegate observe it in `applicationDidFinishLaunching` to call `removeMonitors()` then `registerGlobalHotkey()`.

Keep backward compatibility: if no UserDefaults keys exist, fall back to Shift+Ctrl+C (keyCode 8).
  </action>
  <verify>
Build: `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog build 2>&1 | tail -10`. HotkeyConfig.swift exists with presets, displayString, UserDefaults persistence. CopyhogApp.swift reads from HotkeyConfig instead of hardcoded values. Default behavior (Shift+Ctrl+C) unchanged when no UserDefaults set.
  </verify>
  <done>HotkeyConfig model persists hotkey to UserDefaults with presets. AppDelegate reads hotkey dynamically from HotkeyConfig.shared. Hotkey re-registration happens on config change notification. Default is Shift+Ctrl+C.</done>
</task>

<task type="auto">
  <name>Task 2: Add hotkey picker to SettingsMenu</name>
  <files>Copyhog/Copyhog/Views/SettingsMenu.swift</files>
  <action>
Update SettingsMenu.swift to add a hotkey configuration section:

1. **Add a "Hotkey" submenu or picker** inside the Menu. Use a nested `Menu("Hotkey: \(currentHotkey)")` that contains buttons for each preset from HotkeyConfig. The current selection should be indicated with a checkmark (use `Toggle` or check the label).

Implementation approach:
- Read `HotkeyConfig.shared` to get the current setting
- Use `@State private var currentKeyCode: UInt16` and `@State private var currentModifiers: NSEvent.ModifierFlags` initialized from HotkeyConfig.shared
- For each preset, add a `Button` in the submenu. When tapped:
  - Update HotkeyConfig.shared with the new keyCode and modifiers
  - Call HotkeyConfig.shared.save() (which posts the notification)
  - Update local @State to reflect the change

The submenu label should show the current hotkey: "Hotkey: Shift+Ctrl+C" using HotkeyConfig.shared.displayString.

Place the hotkey submenu between the attribution and the divider (before Hog Wipe).

Order in the gear menu should be:
1. Version display
2. Attribution
3. Divider
4. Hotkey submenu (with presets)
5. Divider
6. Hog Wipe
7. Quit Copyhog
  </action>
  <verify>
Build: `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog build 2>&1 | tail -10`. SettingsMenu.swift contains a hotkey submenu with presets. Current hotkey is displayed in the submenu label.
  </verify>
  <done>Settings menu shows current hotkey and allows selection from presets. Selecting a preset saves to UserDefaults and triggers hotkey re-registration via notification. Menu order is: version, attribution, divider, hotkey picker, divider, Hog Wipe, Quit.</done>
</task>

</tasks>

<verification>
1. `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog build` succeeds
2. HotkeyConfig.swift exists with presets and UserDefaults persistence
3. CopyhogApp.swift uses HotkeyConfig.shared instead of hardcoded values
4. SettingsMenu.swift has hotkey submenu with preset options
5. Default hotkey is still Shift+Ctrl+C when no config exists
</verification>

<success_criteria>
- Hotkey presets available in settings menu
- Selecting a different preset changes the global hotkey immediately
- Hotkey choice persists across app restart
- Settings menu shows current hotkey label
- Default Shift+Ctrl+C works when no custom config exists
- Project compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-settings-menu-with-hotkey-config-version-display-attribution-and-relocated-actions/04.1-02-SUMMARY.md`
</output>
