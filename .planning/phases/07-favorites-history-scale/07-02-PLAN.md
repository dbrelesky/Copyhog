---
phase: 07-favorites-history-scale
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - Copyhog/Copyhog/Views/PopoverContent.swift
  - Copyhog/Copyhog/Views/ItemRow.swift
autonomous: true
requirements: [FAV-01, FAV-02, FAV-04]

must_haves:
  truths:
    - "Pinned items appear in a dedicated 'Pinned' section at the top of the history list"
    - "Unpinned items appear in a separate 'History' section below pinned items"
    - "User can pin an item via right-click context menu"
    - "User can unpin an item via right-click context menu"
    - "Pinned items show a pin icon overlay to visually distinguish them"
    - "When no items are pinned, only the History section is shown (no empty Pinned header)"
  artifacts:
    - path: "Copyhog/Copyhog/Views/PopoverContent.swift"
      provides: "Sectioned layout with Pinned and History sections"
      contains: "pinnedItems"
    - path: "Copyhog/Copyhog/Views/ItemRow.swift"
      provides: "Context menu pin/unpin action and pin icon overlay"
      contains: "onTogglePin"
  key_links:
    - from: "Copyhog/Copyhog/Views/PopoverContent.swift"
      to: "Copyhog/Copyhog/Store/ClipItemStore.swift"
      via: "store.togglePin(id:) called from ItemRow onTogglePin callback"
      pattern: "store\\.togglePin"
    - from: "Copyhog/Copyhog/Views/ItemRow.swift"
      to: "Copyhog/Copyhog/Models/ClipItem.swift"
      via: "reads item.isPinned for context menu label and pin overlay"
      pattern: "item\\.isPinned"
---

<objective>
Update the popover UI to display pinned items in a dedicated section at the top, add pin/unpin context menu action to ItemRow, and add a pin icon overlay on pinned item cards.

Purpose: This completes the user-facing favorites experience -- users can pin, see pinned items prominently, and unpin via context menu.
Output: Sectioned PopoverContent with Pinned/History sections, ItemRow with pin context menu and visual indicator.
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-favorites-history-scale/07-RESEARCH.md
@.planning/phases/07-favorites-history-scale/07-01-SUMMARY.md
@Copyhog/Copyhog/Views/PopoverContent.swift
@Copyhog/Copyhog/Views/ItemRow.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pin/unpin context menu and pin icon overlay to ItemRow</name>
  <files>Copyhog/Copyhog/Views/ItemRow.swift</files>
  <action>
    1. Add `var onTogglePin: (() -> Void)?` optional closure property to ItemRow (same pattern as onDelete, onMarkSensitive)
    2. In the `.contextMenu` block, add a Pin/Unpin button as the FIRST item (before Mark as Sensitive):
       ```
       Button {
           onTogglePin?()
       } label: {
           Label(
               item.isPinned ? "Unpin" : "Pin",
               systemImage: item.isPinned ? "pin.slash" : "pin"
           )
       }
       ```
    3. In the `cardContent` ZStack, add a pin icon overlay (top-left, same position pattern as multi-select checkbox but only shown when NOT in multi-select mode and item IS pinned):
       ```
       if !isMultiSelectActive && item.isPinned {
           VStack {
               HStack {
                   Image(systemName: "pin.fill")
                       .font(.system(size: 10))
                       .foregroundStyle(Color(red: 0.7, green: 0.4, blue: 0.85))
                       .padding(3)
                       .background(.ultraThinMaterial, in: Circle())
                   Spacer()
               }
               Spacer()
           }
           .padding(5)
       }
       ```
       Place this AFTER the multi-select checkbox block so they don't stack -- when multi-select is active, show checkbox; when not, show pin icon for pinned items.
  </action>
  <verify>Build the project with `xcodebuild build -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -destination 'platform=macOS' 2>&1 | tail -5` -- should compile with 0 errors.</verify>
  <done>ItemRow has pin/unpin context menu action and pin icon overlay. Pin icon uses the project's purple accent color and ultraThinMaterial background.</done>
</task>

<task type="auto">
  <name>Task 2: Split PopoverContent into Pinned and History sections with section headers</name>
  <files>Copyhog/Copyhog/Views/PopoverContent.swift</files>
  <action>
    1. Replace the single `ScrollView > LazyVGrid > ForEach(store.items)` with a sectioned layout inside a `ScrollView > LazyVStack(spacing: 0)`:

    2. Compute `pinnedItems` and `unpinnedItems` from `store.items`:
       ```
       let pinnedItems = store.items.filter { $0.isPinned }
       let unpinnedItems = store.items.filter { !$0.isPinned }
       ```

    3. **Pinned section** (only shown when pinnedItems is not empty):
       - Section header: `HStack { Label("Pinned", systemImage: "pin.fill").font(.caption).foregroundStyle(.secondary); Spacer() }.padding(.horizontal, 12).padding(.top, 8)`
       - `LazyVGrid(columns: columns, spacing: 8) { ForEach(pinnedItems) { item in ItemRow(...) } }.padding(.horizontal, 8)`

    4. **History section** (only shown when unpinnedItems is not empty):
       - Section header: `HStack { Label("History", systemImage: "clock").font(.caption).foregroundStyle(.secondary); Spacer() }.padding(.horizontal, 12).padding(.top, 8)`
       - `LazyVGrid(columns: columns, spacing: 8) { ForEach(unpinnedItems) { item in ItemRow(...) } }.padding(.horizontal, 8)`

    5. Extract the grid columns definition to a local variable:
       `let columns = Array(repeating: GridItem(.flexible(), spacing: 8), count: 3)`

    6. For EACH ItemRow in both sections, add the `onTogglePin` callback:
       ```
       onTogglePin: {
           withAnimation {
               store.togglePin(id: item.id)
           }
       }
       ```
       Use `withAnimation` so items animate smoothly between sections when pinned/unpinned.

    7. Keep all existing ItemRow parameters (imageStore, hoveredItemID, isMultiSelectActive, selectedItems, clipboardObserver, onDelete, onMarkSensitive) exactly as they are.

    8. Add bottom padding to the LazyVStack: `.padding(.bottom, 8)` for visual spacing at scroll end.
  </action>
  <verify>Build the project with `xcodebuild build -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -destination 'platform=macOS' 2>&1 | tail -5` -- should compile with 0 errors.</verify>
  <done>PopoverContent shows Pinned section (with header) at top when pinned items exist, History section below. Pin/unpin animates items between sections. All existing functionality (hover, multi-select, copy, drag, delete) preserved.</done>
</task>

</tasks>

<verification>
1. `xcodebuild build` completes with 0 errors
2. Right-clicking an item shows "Pin" in context menu; right-clicking a pinned item shows "Unpin"
3. Pinned items appear under "Pinned" section header at top of list
4. Unpinned items appear under "History" section header
5. Pin icon overlay visible on pinned items (top-left corner)
6. Pinning/unpinning animates the item between sections
7. All existing interactions work: hover preview, tap-to-copy, multi-select, drag-out, delete
</verification>

<success_criteria>
- Pinned items visually separated in dedicated top section with "Pinned" header
- Context menu offers Pin/Unpin based on current state
- Pin icon overlay on pinned item cards (purple, top-left)
- Smooth animation when toggling pin state
- Empty pinned section hides entirely (no orphaned header)
- No regression in existing popover functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-favorites-history-scale/07-02-SUMMARY.md`
</output>
