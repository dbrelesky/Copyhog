---
phase: 03-paste-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Copyhog/Copyhog/Services/PasteboardWriter.swift
  - Copyhog/Copyhog/Views/ItemRow.swift
  - Copyhog/Copyhog/Views/PopoverContent.swift
  - Copyhog/Copyhog/Services/ImageStore.swift
autonomous: true
requirements:
  - PASTE-01
  - PASTE-02
  - PASTE-03

must_haves:
  truths:
    - "Clicking an item row copies its content (text or image) to the system clipboard"
    - "Copied item does not re-appear as a duplicate in the capture list"
    - "A toggle button switches between normal mode and multi-select mode"
    - "In multi-select mode, checkboxes appear on each item row"
    - "Clicking 'Copy N items' writes selected image file URLs and concatenated text to the pasteboard"
  artifacts:
    - path: "Copyhog/Copyhog/Services/PasteboardWriter.swift"
      provides: "Single and batch clipboard write helpers"
      contains: "skipNextChange"
    - path: "Copyhog/Copyhog/Views/PopoverContent.swift"
      provides: "Multi-select state, toggle button, batch copy button"
      contains: "isMultiSelectActive"
    - path: "Copyhog/Copyhog/Views/ItemRow.swift"
      provides: "Tap-to-copy gesture and conditional checkbox"
      contains: "onTapGesture"
    - path: "Copyhog/Copyhog/Services/ImageStore.swift"
      provides: "URL resolution for file paths"
      contains: "resolveURL"
  key_links:
    - from: "Copyhog/Copyhog/Views/ItemRow.swift"
      to: "Copyhog/Copyhog/Services/PasteboardWriter.swift"
      via: "onTapGesture calls PasteboardWriter.write"
      pattern: "PasteboardWriter\\.write"
    - from: "Copyhog/Copyhog/Services/PasteboardWriter.swift"
      to: "Copyhog/Copyhog/Services/ClipboardObserver.swift"
      via: "skipNextChange() called before every pasteboard write"
      pattern: "skipNextChange"
    - from: "Copyhog/Copyhog/Views/PopoverContent.swift"
      to: "Copyhog/Copyhog/Services/PasteboardWriter.swift"
      via: "batch copy button calls PasteboardWriter.writeMultiple"
      pattern: "PasteboardWriter\\.writeMultiple"
---

<objective>
Implement single-click copy-to-clipboard and multi-select batch paste for captured items.

Purpose: Users need to get captured items back into their workflow. Single-click copy is the primary action; multi-select batch paste handles bulk operations for images into apps like Slack or Figma.

Output: PasteboardWriter service, updated ItemRow with tap-to-copy, updated PopoverContent with multi-select mode and batch copy button.
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-paste-actions/03-RESEARCH.md

@Copyhog/Copyhog/Models/ClipItem.swift
@Copyhog/Copyhog/Services/ClipboardObserver.swift
@Copyhog/Copyhog/Services/ImageStore.swift
@Copyhog/Copyhog/Store/ClipItemStore.swift
@Copyhog/Copyhog/Views/ItemRow.swift
@Copyhog/Copyhog/Views/PopoverContent.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PasteboardWriter service and add resolveURL to ImageStore</name>
  <files>Copyhog/Copyhog/Services/PasteboardWriter.swift, Copyhog/Copyhog/Services/ImageStore.swift</files>
  <action>
1. Add a `resolveURL(relativePath:)` method to ImageStore that returns the full `URL` by appending the relative path to `baseDirectory`. This is needed by PasteboardWriter and later by Transferable drag-out. Make it public:
   ```swift
   func resolveURL(relativePath: String) -> URL {
       baseDirectory.appendingPathComponent(relativePath)
   }
   ```

2. Create `Copyhog/Copyhog/Services/PasteboardWriter.swift` with two static methods:

   **`write(_:imageStore:clipboardObserver:)`** — Single-item copy:
   - Call `clipboardObserver.skipNextChange()` BEFORE any pasteboard interaction (prevents re-capture loop)
   - Call `NSPasteboard.general.clearContents()`
   - For `.text` items: `pasteboard.setString(item.content ?? "", forType: .string)`
   - For `.image` items: load the full image via `imageStore.loadImage(relativePath: item.filePath!)`, get `tiffRepresentation`, write via `pasteboard.setData(tiffData, forType: .tiff)`
   - Guard against nil filePath/image gracefully (just return without writing)

   **`writeMultiple(_:imageStore:clipboardObserver:)`** — Batch copy:
   - Call `clipboardObserver.skipNextChange()` BEFORE any pasteboard interaction
   - Call `NSPasteboard.general.clearContents()`
   - Separate items into text and image arrays
   - For text items: concatenate `content` with newline separators, append as `NSString` to objects array
   - For image items: resolve each `filePath` via `imageStore.resolveURL(relativePath:)`, append as `NSURL` to objects array
   - Call `pasteboard.writeObjects(objects)`

   Both methods need `import AppKit` and `import Foundation`. Mark the struct and methods as `@MainActor` since they interact with ClipboardObserver which is `@MainActor`.

3. Add PasteboardWriter.swift to the Xcode project. Run: `python3 -c "..."` or manually add to the pbxproj in the Services group. The file should be added to the same Xcode group as ClipboardObserver.swift and ImageStore.swift.
  </action>
  <verify>Build the project with `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -configuration Debug build 2>&1 | tail -20` — must compile without errors.</verify>
  <done>PasteboardWriter.swift exists with write() and writeMultiple() methods. ImageStore has resolveURL(). Project builds successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Add tap-to-copy on ItemRow and multi-select mode in PopoverContent</name>
  <files>Copyhog/Copyhog/Views/ItemRow.swift, Copyhog/Copyhog/Views/PopoverContent.swift</files>
  <action>
1. **Update PopoverContent.swift** to add multi-select state and UI:

   Add state variables:
   - `@State private var isMultiSelectActive = false`
   - `@State private var selectedItems: Set<UUID> = Set<UUID>()`

   Add a toolbar/header area between PreviewPane and the List with:
   - A toggle button (use `Button` with SF Symbol `checklist.unchecked` / `checklist.checked` or `rectangle.stack.badge.checkmark`) that toggles `isMultiSelectActive`. When toggling OFF, clear `selectedItems`.
   - When `isMultiSelectActive` is true AND `selectedItems` is non-empty, show a "Copy \(selectedItems.count) items" button. On tap, gather the selected `ClipItem` objects from `store.items`, call `PasteboardWriter.writeMultiple(selectedItems, imageStore: store.imageStore, clipboardObserver: clipboardObserver)`, then clear selection and deactivate multi-select.

   The ClipboardObserver needs to be accessible in PopoverContent. It is currently on CopyhogApp. Pass it via `@EnvironmentObject` or add it as a property on ClipItemStore. Check CopyhogApp.swift to see how ClipboardObserver is held. The simplest approach: add `let clipboardObserver: ClipboardObserver` as a property on ClipItemStore (it already holds `imageStore`). Then access via `store.clipboardObserver` in PopoverContent.

   Update the List to pass new bindings to ItemRow:
   - `isMultiSelectActive: isMultiSelectActive`
   - `selectedItems: $selectedItems`
   - `clipboardObserver: store.clipboardObserver`

2. **Update ItemRow.swift** to handle both tap-to-copy and multi-select checkbox:

   Add parameters:
   - `let isMultiSelectActive: Bool`
   - `@Binding var selectedItems: Set<UUID>`
   - `let clipboardObserver: ClipboardObserver`

   In the HStack, at the leading edge, add a conditional checkbox:
   ```swift
   if isMultiSelectActive {
       Image(systemName: selectedItems.contains(item.id) ? "checkmark.circle.fill" : "circle")
           .foregroundStyle(selectedItems.contains(item.id) ? .blue : .secondary)
           .font(.title3)
   }
   ```

   Add `.onTapGesture` to the outer container:
   - If `isMultiSelectActive`: toggle `item.id` in/out of `selectedItems`
   - If NOT `isMultiSelectActive`: call `PasteboardWriter.write(item, imageStore: imageStore, clipboardObserver: clipboardObserver)`

   Use `.contentShape(Rectangle())` on the row to ensure the entire row area is tappable.

3. **Update ClipItemStore.swift** to hold ClipboardObserver reference:
   - Add `let clipboardObserver: ClipboardObserver` property
   - Update `init()` to accept and store it (or create it internally since it needs `imageStore`)
   - Update CopyhogApp.swift accordingly: the ClipboardObserver should be created by ClipItemStore or passed to it

   Check CopyhogApp.swift to see the current initialization pattern and adjust minimally. The key constraint: `ClipboardObserver` is `@MainActor` and needs `imageStore`, and `ClipItemStore` already has `imageStore`. The cleanest approach is for `ClipItemStore` to create and own `ClipboardObserver`.

4. Update the `#Preview` in PopoverContent.swift to still compile (may need a mock or just remove the preview temporarily).
  </action>
  <verify>Build the project with `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -configuration Debug build 2>&1 | tail -20` — must compile without errors. Visually verify by launching the app: clicking an item should copy to clipboard (paste into TextEdit to confirm). Toggle multi-select should show checkboxes. Selecting items and clicking "Copy N items" should write to clipboard.</verify>
  <done>Clicking a non-multi-select row copies the item to clipboard without creating a duplicate entry. Multi-select mode shows checkboxes, and the "Copy N items" button writes selected items to the pasteboard. Project builds and runs.</done>
</task>

</tasks>

<verification>
1. Build: `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -configuration Debug build` succeeds
2. Single-click copy: Click a text item in the popover, then Cmd+V in TextEdit — the text appears
3. Single-click image copy: Click an image item, then Cmd+V in a rich text editor — the image appears
4. No duplicate: After clicking to copy, the item list does not grow (skipNextChange prevents re-capture)
5. Multi-select toggle: Click the multi-select button — checkboxes appear on rows
6. Batch copy: Select 2+ items, click "Copy N items" — pasteboard contains the items
7. Toggle off: Clicking multi-select button again hides checkboxes and clears selection
</verification>

<success_criteria>
- PasteboardWriter service handles single and batch clipboard writes
- Clicking an item row copies it to the system clipboard without creating duplicates
- Multi-select mode toggles checkboxes on/off with a toolbar button
- "Copy N items" button writes selected items to pasteboard (file URLs for images, concatenated text for text)
- App builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-paste-actions/03-01-SUMMARY.md`
</output>
