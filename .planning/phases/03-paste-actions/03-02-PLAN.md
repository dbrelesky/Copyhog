---
phase: 03-paste-actions
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - Copyhog/Copyhog/Models/ClipItem.swift
  - Copyhog/Copyhog/Views/ItemRow.swift
autonomous: false
requirements:
  - PASTE-04

must_haves:
  truths:
    - "An image item can be dragged from the popover into Finder and the file appears"
    - "A text item can be dragged from the popover into TextEdit and the text appears"
    - "Dragging does not break the existing tap-to-copy behavior"
  artifacts:
    - path: "Copyhog/Copyhog/Models/ClipItem.swift"
      provides: "Transferable conformance for drag-out"
      contains: "Transferable"
    - path: "Copyhog/Copyhog/Views/ItemRow.swift"
      provides: "draggable modifier on row content"
      contains: ".draggable"
  key_links:
    - from: "Copyhog/Copyhog/Views/ItemRow.swift"
      to: "Copyhog/Copyhog/Models/ClipItem.swift"
      via: ".draggable(item) uses Transferable conformance"
      pattern: "\\.draggable"
    - from: "Copyhog/Copyhog/Models/ClipItem.swift"
      to: "Copyhog/Copyhog/Services/ImageStore.swift"
      via: "FileRepresentation resolves image path to URL"
      pattern: "resolveURL\\|SentTransferredFile"
---

<objective>
Add drag-out support so items can be dragged from the popover directly into target apps.

Purpose: Drag-out is the most direct way to move captured content into another app — no paste step required. This completes the paste actions feature set.

Output: ClipItem with Transferable conformance, ItemRow with .draggable modifier, verified drag-out into Finder and TextEdit.
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-paste-actions/03-RESEARCH.md
@.planning/phases/03-paste-actions/03-01-SUMMARY.md

@Copyhog/Copyhog/Models/ClipItem.swift
@Copyhog/Copyhog/Views/ItemRow.swift
@Copyhog/Copyhog/Services/ImageStore.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Transferable conformance to ClipItem and .draggable to ItemRow</name>
  <files>Copyhog/Copyhog/Models/ClipItem.swift, Copyhog/Copyhog/Views/ItemRow.swift</files>
  <action>
1. **Add Transferable conformance to ClipItem.swift:**

   Add `import UniformTypeIdentifiers` at the top.

   Add an extension conforming ClipItem to Transferable:
   ```swift
   extension ClipItem: Transferable {
       static var transferRepresentation: some TransferRepresentation {
           DataRepresentation(exportedContentType: .plainText) { item in
               guard item.type == .text, let content = item.content else {
                   throw CocoaError(.fileNoSuchFile)
               }
               return Data(content.utf8)
           }

           FileRepresentation(exportedContentType: .png) { item in
               guard item.type == .image, let filePath = item.filePath else {
                   throw CocoaError(.fileNoSuchFile)
               }
               let url = ImageStore().resolveURL(relativePath: filePath)
               return SentTransferredFile(url)
           }

           // CRITICAL: ProxyRepresentation needed for Finder/Slack compatibility
           // FileRepresentation alone fails on macOS 13-14 (Apple FB13454434)
           ProxyRepresentation { item in
               if item.type == .text {
                   return item.content ?? ""
               } else if let filePath = item.filePath {
                   return ImageStore().resolveURL(relativePath: filePath).absoluteString
               }
               return ""
           }
       }
   }
   ```

   Note: Creating `ImageStore()` instances in the Transferable conformance is acceptable because ImageStore only resolves a path (no heavy initialization beyond creating the base directory URL). If this becomes a concern, a static helper could be added, but for v1 this is fine.

2. **Update ItemRow.swift to add .draggable modifier:**

   The key challenge is combining `.draggable` with the existing `.onTapGesture` without gesture conflicts. Per research, put `.draggable` on the inner content and `.simultaneousGesture(TapGesture())` on the outer container.

   Restructure the ItemRow body:
   - Extract the current HStack content into a computed property or local variable (e.g., `rowContent`)
   - Apply `.draggable(item)` to `rowContent` with a lightweight drag preview (a Label with the item type icon)
   - On the outer container (the top-level view with padding/background), replace `.onTapGesture` with `.simultaneousGesture(TapGesture().onEnded { ... })` that handles both multi-select and single-copy tap logic (carried over from plan 03-01)
   - Keep `.onHover` on the outer container as before
   - Keep `.contentShape(Rectangle())` to ensure the full row is interactive

   Example structure:
   ```swift
   var body: some View {
       HStack(spacing: 8) {
           if isMultiSelectActive { /* checkbox */ }

           // Inner content with draggable
           rowContent
               .draggable(item) {
                   Label(item.type == .text ? "Text" : "Image",
                         systemImage: item.type == .text ? "doc.text" : "photo")
               }
       }
       .padding(...)
       .background(...)
       .clipShape(...)
       .contentShape(Rectangle())
       .simultaneousGesture(TapGesture().onEnded {
           // tap logic from plan 01
       })
       .onHover { ... }
   }

   @ViewBuilder
   private var rowContent: some View {
       // thumbnail + content + timestamp from existing layout
   }
   ```

   The checkbox should be OUTSIDE the draggable area (in the outer HStack) so that tapping the checkbox doesn't initiate a drag.
  </action>
  <verify>Build the project with `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -configuration Debug build 2>&1 | tail -20` — must compile without errors. Launch the app and verify: (1) drag an image item to Finder desktop — file should appear, (2) drag a text item to TextEdit — text should appear, (3) clicking a row still copies to clipboard (tap not swallowed by drag).</verify>
  <done>ClipItem conforms to Transferable with text, image, and proxy representations. ItemRow has .draggable modifier. Dragging items out of the popover works for both text and images. Tap-to-copy still functions.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all paste actions work end-to-end</name>
  <what-built>Complete paste actions: single-click copy, multi-select batch paste, and drag-out for both text and image items.</what-built>
  <how-to-verify>
    1. Launch Copyhog from Xcode (Cmd+R)
    2. Copy some text and an image to populate the clipboard history
    3. **Single-click copy (text):** Click a text item in the popover, open TextEdit, press Cmd+V — the text should appear
    4. **Single-click copy (image):** Click an image item, open a rich text editor or Preview (File > New from Clipboard), press Cmd+V — the image should appear
    5. **No duplicates:** After copying, check that the item list did not grow (no duplicate entry)
    6. **Multi-select mode:** Click the multi-select toggle button — checkboxes should appear on each row
    7. **Select and batch copy:** Check 2-3 items, click the "Copy N items" button, then paste into an app — content should be pasted
    8. **Toggle off:** Click multi-select toggle again — checkboxes disappear, selection clears
    9. **Drag text:** Drag a text item from the popover into TextEdit — text should appear
    10. **Drag image:** Drag an image item from the popover to the Finder desktop — the image file should appear
    11. **Tap still works after drag:** After dragging, try clicking a different item — it should still copy to clipboard
  </how-to-verify>
  <resume-signal>Type "approved" if all 11 checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build: `xcodebuild -project Copyhog/Copyhog.xcodeproj -scheme Copyhog -configuration Debug build` succeeds
2. Drag image to Finder: file appears on desktop
3. Drag text to TextEdit: text appears in document
4. Click-to-copy still works alongside drag (no gesture conflict)
5. All three paste actions (single-click, batch, drag-out) function correctly
</verification>

<success_criteria>
- ClipItem conforms to Transferable with DataRepresentation (text), FileRepresentation (image), and ProxyRepresentation (compatibility)
- .draggable modifier on ItemRow enables drag-out without breaking tap-to-copy
- Image items can be dragged into Finder and the file appears
- Text items can be dragged into TextEdit and the text appears
- Human verification confirms all paste actions work end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/03-paste-actions/03-02-SUMMARY.md`
</output>
